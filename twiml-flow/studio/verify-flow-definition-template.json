{
  "states": [
    {
      "transitions": [
        {
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall",
          "next": "set_variables"
        },
        {
          "event": "incomingRequest"
        }
      ],
      "type": "trigger",
      "name": "Trigger",
      "properties": {
        "offset": {
          "y": 0,
          "x": 0
        }
      }
    },
    {
      "transitions": [
        {
          "event": "audioComplete"
        }
      ],
      "type": "say-play",
      "name": "verification_complete",
      "properties": {
        "say": "You have been verified with score {{widgets.submit_verification.parsed.score}}",
        "voice": "Polly.Russell",
        "language": "en-AU",
        "loop": 1,
        "offset": {
          "y": 1610,
          "x": 290
        }
      }
    },
    {
      "transitions": [
        {
          "event": "next",
          "next": "verify_function"
        }
      ],
      "type": "set-variables",
      "name": "set_variables",
      "properties": {
        "variables": [
          {
            "index": "0",
            "key": "count",
            "value": "0"
          },
          {
            "index": "1",
            "key": "digits",
            "value": "6"
          },
          {
            "key": "enrolType",
            "value": "Digits"
          },
          {
            "key": "connectorKey",
            "value": "${armorvox-twilio-connector-accesskey}"
          },
          {
            "index": "4",
            "key": "connector_server_local",
            "value": "${armorvox-twilio-connector-host}"
          },
          {
            "key": "functions_host",
            "value": "${twilio-functions-webhook-host}"
          },
          {
            "key": "connector_server",
            "value": "${armorvox-twilio-connector-host}"
          }
        ],
        "offset": {
          "y": 180,
          "x": 100
        }
      }
    },
    {
      "transitions": [
        {
          "event": "return",
          "next": "submit_SpeechResult"
        },
        {
          "event": "timeout"
        },
        {
          "event": "fail"
        }
      ],
      "type": "add-twiml-redirect",
      "name": "verify_function",
      "properties": {
        "url": "https://{{flow.variables.functions_host}}/verify/verify_gather?Attempt={{flow.variables.count}}&FlowSid={{flow.flow_sid}}",
        "method": "POST",
        "timeout": "14400",
        "offset": {
          "y": 420,
          "x": 100
        }
      }
    },
    {
      "transitions": [
        {
          "event": "success",
          "next": "submit_verification"
        },
        {
          "event": "failed"
        }
      ],
      "type": "make-http-request",
      "name": "submit_SpeechResult",
      "properties": {
        "url": "https://{{flow.variables.connector_server}}/recresult",
        "parameters": [
          {
            "key": "SpeechResult",
            "value": "{{widgets.verify_function.SpeechResult}}"
          },
          {
            "key": "Confidence",
            "value": "{{widgets.verify_function.Confidence}}"
          },
          {
            "key": "Caller",
            "value": "{{trigger.call.From}}"
          },
          {
            "key": "CallSid",
            "value": "{{trigger.call.CallSid}}"
          },
          {
            "key": "Count",
            "value": "{{flow.variables.count}}"
          },
          {
            "key": "mode",
            "value": "verify"
          }
        ],
        "method": "POST",
        "content_type": "application/x-www-form-urlencoded;charset=utf-8",
        "offset": {
          "y": 650,
          "x": 100
        }
      }
    },
    {
      "transitions": [
        {
          "event": "success",
          "next": "is_verified"
        },
        {
          "event": "failed"
        }
      ],
      "type": "make-http-request",
      "name": "submit_verification",
      "properties": {
        "url": "https://{{flow.variables.connector_server}}/verify",
        "parameters": [
          {
            "key": "CallSid",
            "value": "{{trigger.call.CallSid}}"
          },
          {
            "key": "AccessKey",
            "value": "{{flow.variables.connectorKey}}"
          },
          {
            "key": "Attempt",
            "value": "{{flow.variables.count}}"
          }
        ],
        "method": "POST",
        "content_type": "application/x-www-form-urlencoded;charset=utf-8",
        "offset": {
          "y": 970,
          "x": 100
        }
      }
    },
    {
      "transitions": [
        {
          "event": "noMatch",
          "next": "likely_imposter"
        },
        {
          "conditions": [
            {
              "type": "equal_to",
              "friendly_name": "If value equal_to good",
              "arguments": [
                "{{widgets.submit_verification.parsed.status}}"
              ],
              "value": "good"
            }
          ],
          "event": "match",
          "next": "verification_complete"
        }
      ],
      "type": "split-based-on",
      "name": "is_verified",
      "properties": {
        "input": "{{widgets.submit_verification.parsed.status}}",
        "offset": {
          "y": 1280,
          "x": 80
        }
      }
    },
    {
      "transitions": [
        {
          "event": "audioComplete"
        }
      ],
      "type": "say-play",
      "name": "likely_imposter",
      "properties": {
        "say": "Sorry, I can't verify you. Your score was {{widgets.submit_verification.parsed.score}} . Likely imposter probability of {{widgets.submit_verification.parsed.impostor_prob}} percent.",
        "voice": "Polly.Russell",
        "language": "en-AU",
        "loop": 1,
        "offset": {
          "y": 1640,
          "x": -270
        }
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  },
  "description": "VerifyFlow"
}
